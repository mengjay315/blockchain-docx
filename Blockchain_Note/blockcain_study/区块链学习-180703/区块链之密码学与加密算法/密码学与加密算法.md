# 密码学与加密算法
## 密码学的本质是算力差

密码学与系统安全
![密码学与系统安全](_v_images/20190212141235349_2116688807.png)

密码学与KYC
![KYC-实名认证](_v_images/20190212141446839_567084349.png)

传统的技术架构
![密钥服务平台-服务架构](_v_images/20190212141615596_1702386565.png)


## 加密算法的分类:
**对称加密算法, 非对称加密算法, hash算法**

### 1. 对称加密算法
**对称加密特点:**
**优点**：
对称加密算法的特点是算法公开、**计算量小**、加密速度快、加密效率高。

**缺点**:
交易双方都**使用同样钥匙，安全性得不到保证**。
**密钥管理成为用户的负担**
对称加密算法在分布式网络系统上使用较为困难，主要是因为密钥管理困难，使用成本较高。

**对称加密举例**
DES(Data Encryption Standard)：数据加密标准(现在用的比较少，因为它的**加密强度不够**，能够暴力破解)

 3DES：原理和DES几乎是一样的，只是使用3个密钥，对相同的数据执行三次加密，增强加密强度。(缺点：**要维护3个密钥，大大增加了维护成本**)

AES(Advanced Encryption Standard)：高级加密标准，目前美国国家安全局使用的，苹果的钥匙串访问采用的就AES加密。**是现在公认的最安全的加密方式**，是对称密钥加密中最流行的算法。

Poly1305消息认证码
**消息认证码**（带密钥的Hash函数）:密码学中，通信实体双方使用的一种验证机制，保证消息数据完整性的一种工具。安全性依赖于Hash函数，故也称**带密钥的Hash函数**。消息认证码是基于密钥和消息摘要所获得的一个值，可用于数据源认证和完整性校验。
性能强大，在CPU为精简指令集的ARM平台上尤为显著（ARM v8前效果较明显），在同等配置的手机中表现是AES的4倍

对称加密在区块链中的应用-**Keystore**
geth --datadir data init genesis.json
geth --datadir data account new

![keystore](_v_images/20190212142746740_486703026.png)


#### 1.1对称加密算法-AES
**基本概念**

密码学中，块密码的工作模式（英语：mode of operation）允许使用同一个块密码密钥对多于一块的数据进行加密，并保证其安全性。

**块密码自身只能加密长度等于密码块长度的单块数据**，若要加密变长数据，则数据必须先被划分为一些单独的密码块。通常而言，最后一块数据也需要使用合适填充方式将数据扩展到符合密码块大小的长度。一种工作模式描述了加密每一数据块的过程，并常常使用基于一个通常称为**初始化向量**的附加输入值以进行随机化，以保证安全。常见的模式有ECB，CBC，OFB，CFB和CTR等

**加密模式仅仅保证机密性 ，对于保证完整性或未篡改，需要采用分离的消息验证码**。
密码学社区开始研究结合了**加密和认证的单一模式**，这种模式被称为认证加密模式（AE，Authenticated Encryption）。

**初始化向量(IV)**
初始化向量（IV，Initialization Vector）是许多工作模式中用于**随机化加密的一块数据**，因此**可以由相同的明文，相同的密钥产生不同的密文**，而无需重新产生密钥，避免了通常相当复杂的这一过程。

初始化向量与密钥相比**有不同的安全性需求**，因此IV通常无须保密，然而在大多数情况中，**不应当在使用同一密钥的情况下两次使用同一个IV**。

![1](_v_images/20190212152314854_1953924498.png)
![2](_v_images/20190212152340821_1961140517.png)
![3](_v_images/20190212152451728_1119326657.png)
![4](_v_images/20190212152526977_369388770.png)
![5](_v_images/20190212152734292_1155828052.png)

## 2.Hash的举例
    MD4：（RFC 1320）是 MIT 的 Ronald L. Rivest 在 1990 年设计的，MD 是 Message Digest 的缩写。其输出为 128 位。MD4 已证明不够安全。

    MD5（RFC 1321）是 Rivest 于1991年对 MD4 的改进版本。它对输入仍以 512 位分组，其输出是 128 位。MD5 比 MD4 复杂，并且计算速度要慢一点，更安全一些。**MD5 已被证明不具备”强抗碰撞性”**。

    SHA （Secure Hash Algorithm）是一个 Hash 函数族，由 NIST（National Institute of Standards and Technology）于 1993 年发布第一个算法。目前知名的 SHA-1 在 1995 年面世，它的输出为长度 160 位的 hash 值，因此抗穷举性更好。SHA-1 设计时基于和 MD4 相同原理，并且模仿了该算法。**SHA-1 已被证明不具”强抗碰撞性”**。

    为了提高安全性，NIST 还设计出了 SHA-224、SHA-256、SHA-384，和 SHA-512 算法（统称为 SHA-2），跟 SHA-1 算法原理类似。
    SHA-3 相关算法也已被提出， 美国NIST选择了**Keccak算法作为SHA - 3的标准算法**。
    Keccak拥有良好的加密性能以及抗解密能力。
    Ethereum和Solidity智能合约代码中的SHA3是指**Keccak256**，而不是标准的NIST-SHA3，**为了避免混淆，直接在合约代码中写成Keccak256是最清晰的**。

### 2.1 Hash的特点
    **正向快速：**给定明文和 hash 算法，在有限时间和有限资源内能计算出 hash 值。

    **逆向困难**：给定（若干） hash 值，在有限时间内很难（基本不可能）逆推出明文。

    **输入敏感**：原始输入信息修改一点信息，产生的 hash 值看起来应该都有很大不同。

    **冲突避免**：很难找到两段内容不同的明文，使得它们的 hash 值一致（发生冲突）。即对于任意两个不同的数据块，其hash值相同的可能性极小；对于一个给定的数据块，找到和它hash值相同的数据块极为困难。

    HASH的定义:
    任意长的数据通过算法压缩成一个固定长的数据。比如哈希函数SHA256将任意长的数据通过算法压缩成一个固定的长为256比特的数据。

    特点：哈希函数能将任意长的输入数据压缩成固定长且短的数据，节省存储空间.

![hash碰撞定义](_v_images/20190212161829834_1016620547.png)

## 3. 非对称加密特点
    缺点:
    算法强度复杂、安全性依赖于算法与密钥但是由于其算法复杂，而使得加密解密速度没有对称加密解密的速度快。

    优点:
    对称密码体制中只有一种密钥，并且是非公开的，如果要解密就得让对方知道密钥。
    所以保证其安全性就是保证密钥的安全，而非对称密钥体制有两种密钥，其中一个是公开的，这样就可以不需要像对称密码那样传输对方的密钥了。这样安全性就大了很多。

    **非对称加解密工作原理**
    1.A要向B发送信息，A和B都要产生一对用于加密非对称加密算法和解密的公钥和私钥。
    2.A的私钥保密，A的公钥告诉B；B的私钥保密，B的公钥告诉A。
    3.A要给B发送信息时，A用B的公钥加密信息，因为A知道B的公钥。
    4.A将这个消息发给B（已经用B的公钥加密消息）。
    5.B收到这个消息后，B用自己的私钥解密A的消息。其他所有收到这个报文的人都无法解密，因为只有B才有B的私钥。
![非对称加密的工作原理](_v_images/20190212162315068_358489256.png)

### secp256k1 -非对称加密算法
**非对称加密算法有两个应用场景:加密解密、签名验签。典型的非对称加密算法有RSA**

    1. 加密解密
    假设B要和A秘密交流：

    A根据RSA算法生成了一个私钥、公钥对。公钥是公开的，任何人都可以知道，包括B；私钥只有A知道。
    B将自己想要对A说的明文使用A的公钥通过RSA加密，生成密文，发送出去。
    A接收到来自B的密文，使用自己的私钥通过RSA解密，生成明文。
    此场景主要为了防止中间人截获信息，即使中间人截获到密文，就算他知道A的公钥，由于不知道A的私钥，还是无法知道密文啥意思。

    2. 签名验签
    假设B要确定A是A，而不是中间者伪造的：

    A根据RSA算法生成了一个私钥、公钥对。公钥是公开的，任何人都可以知道，包括B；私钥只有A知道。
    A使用自己的私钥对一段消息进行签名。
    B使用A的公钥对同一段消息进行验签，成功则证明A是A。
    签名验签是为了解决中间人伪造A与B通信的问题。

![非对称加密算法](_v_images/20190212162713178_1376048021.png)

    我们在“加密”和“解密”的过程中分别使用两个密码
    （1）私钥：是信息拥有者才知道的，**可以加密信息或者解密公钥数据**（信息的安全性）
    （2）公钥：是公开全网可见的，**用公钥来验证信息，加密数据**（信息的真实性）；

    （3）非对称加密椭圆曲线加密算法(ECC)>secp256k1
    该公式对应的曲线即为图中红色部分.
    数学公式：
    y^2 ≡ x^3 + ax + b (mod p)
    a = 0， b = 7 (此时对应的算法为secp256k1)
    p = FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFE FFFFFC2F
    = 2^256 − 2^32 − 2^9 − 2^8 − 2^7 − 2^6 − 2^4 − 1
    G = 02 79BE667E F9DCBBAC 55A06295 CE870B07 029BFCDB 2DCE28D9 59F2815B 16F81798

![解析](_v_images/20190213094636800_1785612653.png)

#### 椭圆曲线数字签名算法(ECDSA)-签名过程
    用户的密钥对:（d, Q）；(d为私钥，Q为公钥)
    待签名的信息：M
    签名：Signature(M) = ( r, s)

    签名过程：
    1、根据ECC算法随机生成一个密钥对(k, R), R=(xR, yR)
    2、令 r = xR mod n，如果r = 0，则返回步骤1
    3、计算 H = Hash(M)
    4、按照数据类型转换规则，将H转化为一个big endian的整数e
    5、s = k^-1 (e + rd) mod n，若s = 0, 则返回步骤1
    6、输出的S =(r,s)即为签名。

    n = FFFFFFFF FFFFFFFF FFFFFFFF FFFFFFFE BAAEDCE6 AF48A03B BFD25E8C D0364141
![签名过程](_v_images/20190213101830129_220089010.png)
----------------------------------------------------------------------------------------------------------------------------------

#### 椭圆曲线数字签名算法(ECDSA)-验证过程
    用户的密钥对:（d, Q）；(d为私钥，Q为公钥)
    待签名的信息：M
    签名：Signature(M) = ( r, s)

    验签过程：
    1、计算 H = Hash(M)
    2、按照数据类型转换规则，将H转化为一个big endian的整数e
    3、计算 u1 = es^-1 mod n, u2 = rs^-1 mod n
    4、计算 R = (xR, yR) = u1G + u2Q, 如果R = 零点，则验证该签名无效
    5、令 v = xR mod n
    6、若 v == r，则签名有效，若 v ≠ r, 则签名无效。
![验签过程](_v_images/20190213103543465_1187538473.png)
![六层模型之数据层](_v_images/20190213103731637_1089696427.png)

# 以上讲的关于加密算法, 可以参考Go语言版的比特币源码进行分析.
![环境搭建-btcd](_v_images/20190213145535626_725208873.png)

![环境搭建-btcwallet](_v_images/20190213145619133_1400262924.png)


![debug-wallet-creat](_v_images/20190213145800209_1645512746.png)


![wallet-create](_v_images/20190213145830200_240941114.png)


![源代码debug-gencerts](_v_images/20190213145911335_1506302506.png)


## 4. 密码学扩展
### 4.1 PKI体系
在非对称加密中，公钥则可以通过证书机制来进行保护，如何管理和分发证书则可以通过 PKI（Public Key Infrastructure）来保障。

PKI 并不代表某个特定的密码学技术和流程，PKI 是建立在公私钥基础上实现安全可靠传递消息和身份确认的一个通用框架。实现了 PKI 的平台可以安全可靠地管理网络中用户的密钥和证书，包括多个实现和变种，知名的有** RSA **公司的 PKCS（Public Key Cryptography Standards）标准和** X.509 规范**等。

1.CA（Certification Authority）：负责证书的颁发和作废，接收来自 RA 的请求，是最核心的部分；
2.RA（Registration Authority）：对用户身份进行验证，校验数据合法性，负责登记，审核过了就发给 CA；
3.证书数据库：存放证书，一般采用 LDAP 目录服务，标准格式采用 X.500 系列。
![PKI体系](_v_images/20190213104819623_423932077.png)


### 4.2 同态加密-介绍(以后可能会很流行的加密算法)
    如果满足 f(A)+f(B)=f(A+B)  加法同态
    如果满足 f(A)×f(B)=f(A×B)  乘法同态
    同时满足加法同态和乘法同态，称为全同态加密

    同态加密算法
    RSA 算法对于乘法操作是同态的。
    Paillier 算法则是对加法同态的。
    Gentry算法则是全同态的。


**对数据进行加密给计算带来了难度，但如能够在不解密的前提下进行计算则进一步提高了数据的安全性**。

**同态加密-用途**
![同态加密的用途](_v_images/20190213105820732_1677019898.png)

### 4.3 零知识证明
零知识证明指证明者（被验证者）能够在不向验证者提供任何有用的信息的情况下，使验证者相信某个论断是正确的协议。
Zcash交易自动隐藏区块链上所有交易的发送者、接受者及数额。只有那些拥有查看密钥的人才能看到交易的内容。用户拥有完全的控制权，他们可自行选择向其他人提供查看密钥。

### 4.4 国密

国密即国家密码局认定的国产密码算法，即商用密码。

国密算法是国家密码局制定标准的一系列算法。
其中包括了对称加密算法，椭圆曲线非对称加密算法，杂凑算法。

SM1 对称加密算法，加密强度为128位，采用硬件实现                          =>AES
SM2 为国家密码管理局公布的公钥算法，其加密强度为256位。          =>ECC
SM3 密码杂凑算法，杂凑值长度为32字节，和SM2算法同期公布        =>MD5
SM4 对称加密算法，可使用软件实现，加密强度为128位。                  =>无限局域网产品使用










